name: SCP Traffic Generation - SkyhighTenant

on:
  schedule:
    - cron: '0 2 * * *'  # 2:00 AM UTC
  workflow_dispatch:

jobs:
  SkyhighTenant-run:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize diagnostics
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path diagnostics -Force | Out-Null
        "Workflow: $env:GITHUB_WORKFLOW" | Out-File -FilePath diagnostics/scp-debug.log -Encoding utf8
        "Run ID: $env:GITHUB_RUN_ID" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Runner: $env:RUNNER_NAME / $env:RUNNER_OS" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Timestamp: $(Get-Date -Format o)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
    
    - name: Copy Files Over from Private Repo
      shell: pwsh
      env:
        PAT: ${{ secrets.NewSCPToken }}
      run: |
        $ErrorActionPreference = "Stop"
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/SCP-Windows-493_304.zip -Headers @{Authorization="Token $($env:PAT)"} -OutFile SCP-Windows-493_304.zip
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/SkyhighTenant/SCP%20Workflow%20Policy-157.opg -Headers @{Authorization="Token $($env:PAT)"} -OutFile "SCP Workflow Policy-157.opg"
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/SkyhighTenant/CA_Skyhigh.pem -Headers @{Authorization="Token $($env:PAT)"} -OutFile CA_Skyhigh.pem
        Write-Host "::group::Downloaded Files"
        Get-Item SCP-Windows-493_304.zip, "SCP Workflow Policy-157.opg", CA_Skyhigh.pem | Select-Object Name,Length,LastWriteTime | Format-Table -AutoSize
        Get-FileHash SCP-Windows-493_304.zip, "SCP Workflow Policy-157.opg", CA_Skyhigh.pem -Algorithm SHA256 | Format-Table -AutoSize
        Write-Host "::endgroup::"
        Get-FileHash SCP-Windows-493_304.zip, "SCP Workflow Policy-157.opg", CA_Skyhigh.pem -Algorithm SHA256 | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

    - name: Unpack the SCP Zip
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        7z x ./SCP-Windows-493_304.zip
        Get-ChildItem -Path . -Filter *.msi -Recurse | Select-Object FullName,Length | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

    - name: Pre-install service snapshot
      shell: pwsh
      run: |
        "=== Pre-install services ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue |
            Select-Object Name,DisplayName,Status,StartType | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Service snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }
        "=== Pre-install processes ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Process -Name "*scp*", "*skyhigh*", "chrome" -ErrorAction SilentlyContinue |
            Select-Object Name,Id,StartTime | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Process snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }

    - name: Install Windows SCP application
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Start-Process msiexec -ArgumentList "/i ScpInstaller.x64.msi /quiet" -wait

    - name: Post-install service snapshot
      shell: pwsh
      run: |
        Write-Host "::group::Post-install services"
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue | Format-Table Name,DisplayName,Status,StartType -AutoSize
        } catch {
          Write-Host "Post-install service snapshot failed: $($_.Exception.Message)"
        }
        Write-Host "::endgroup::"
        "=== Post-install services ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue |
            Select-Object Name,DisplayName,Status,StartType | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Post-install service snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }

    - name: Deploy OPG Policy
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Copy-Item -Path "./SCP Workflow Policy-157.opg" -Destination "C:\ProgramData\Skyhigh\SCP\Policy\Temp\SCPPolicy.opg"

    - name: Install Root CA
      timeout-minutes: 5
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $ts = Get-Date -Format o
        $caPath = "./CA_Skyhigh.pem"
        if (-not (Test-Path $caPath)) {
          throw "Root CA file not found at $caPath"
        }

        Write-Host "::group::Root CA install diagnostics"
        Write-Host "Start: $ts"
        Get-Item $caPath | Select-Object FullName,Length,LastWriteTime | Format-List
        Get-FileHash $caPath -Algorithm SHA256 | Format-Table -AutoSize

        $sw = [System.Diagnostics.Stopwatch]::StartNew()
        $imported = Import-Certificate $caPath -CertStoreLocation Cert:\LocalMachine\Root\ -Confirm:$false
        $sw.Stop()

        if ($null -eq $imported -or $imported.Count -eq 0) {
          Write-Host "Import-Certificate returned no certificate objects."
        } else {
          foreach ($cert in $imported) {
            Write-Host "Imported cert thumbprint: $($cert.Thumbprint)"
            Write-Host "Imported cert subject: $($cert.Subject)"
          }

          $store = Get-ChildItem Cert:\LocalMachine\Root -ErrorAction SilentlyContinue
          foreach ($cert in $imported) {
            $present = $store | Where-Object { $_.Thumbprint -eq $cert.Thumbprint }
            Write-Host "Present in LocalMachine\\Root: $([bool]$present) ($($cert.Thumbprint))"
          }
        }

        Write-Host "Import duration seconds: $([Math]::Round($sw.Elapsed.TotalSeconds, 2))"
        "Root CA import at ${ts}; duration_seconds=$([Math]::Round($sw.Elapsed.TotalSeconds, 2))" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "### Root CA Summary" >> $env:GITHUB_STEP_SUMMARY
        "- Import started: $ts" >> $env:GITHUB_STEP_SUMMARY
        "- Import duration seconds: $([Math]::Round($sw.Elapsed.TotalSeconds, 2))" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "::endgroup::"

    - name: Wait after CA installation
      shell: pwsh
      run: Start-Sleep -Seconds 10

    - name: Check SCP Connection Status
      id: check_scp
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $ts = Get-Date -Format o
        $regPath = "HKLM:\SOFTWARE\Skyhigh\SCP\About"
        $valueName = "Connection Status"

        Write-Host "::group::SCP Connection Diagnostics"
        Write-Host "Timestamp: $ts"
        Write-Host "Runner: $env:RUNNER_NAME / $env:RUNNER_OS"
        Write-Host "Registry path: $regPath"
        try {
            $status = Get-ItemPropertyValue -Path $regPath -Name $valueName -ErrorAction Stop
            Write-Host "SCP registry status: '$status'"
            "SCP status: $status at $ts" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            if ($status -eq "Connected") {
                "is_connected=true" >> $env:GITHUB_OUTPUT
            } else {
                "is_connected=false" >> $env:GITHUB_OUTPUT
            }
        } catch {
            Write-Host "Failed to read registry key: $($_.Exception.Message)"
            "SCP status read failed at ${ts}: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            "is_connected=false" >> $env:GITHUB_OUTPUT
        }
        Write-Host "::endgroup::"

    - name: Browser diagnostics
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Write-Host "::group::Browser Diagnostics"
        $browserCmd = Get-Command chrome.exe -ErrorAction SilentlyContinue
        if ($null -eq $browserCmd) {
          $browserCmd = Get-Command msedge.exe -ErrorAction SilentlyContinue
        }

        if ($null -eq $browserCmd) {
          "No supported browser found (checked chrome.exe, msedge.exe)." | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          Write-Host "::endgroup::"
          throw "No supported browser found (checked chrome.exe, msedge.exe)."
        }

        Write-Host "Selected browser: $($browserCmd.Name) at $($browserCmd.Source)"
        & $browserCmd.Source --version
        "Selected browser: $($browserCmd.Source)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "BROWSER_EXE=$($browserCmd.Source)" >> $env:GITHUB_ENV
        Write-Host "::endgroup::"

    - name: Access top websites from external list
      if: steps.check_scp.outputs.is_connected == 'true'
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        if (-not $env:BROWSER_EXE) {
          throw "BROWSER_EXE environment variable is not set."
        }

        # Load the list of URLs from the JSON file
        $topSites = Get-Content "top-sites.json" | ConvertFrom-Json

        # Select 30 random URLs
        $selected = Get-Random -InputObject $topSites -Count 30
        $successCount = 0
        $failureCount = 0
        $urlIndex = 0

        "Selected URL count: $($selected.Count)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "First 5 URLs: $((($selected | Select-Object -First 5) -join ', '))" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Browser executable: $env:BROWSER_EXE" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "### SCP Traffic Summary" >> $env:GITHUB_STEP_SUMMARY
        "- SCP connection status: Connected" >> $env:GITHUB_STEP_SUMMARY
        "- Selected URL count: $($selected.Count)" >> $env:GITHUB_STEP_SUMMARY
        "- Browser executable: $env:BROWSER_EXE" >> $env:GITHUB_STEP_SUMMARY

        # Open each site in Chrome (or Edge)
        foreach ($site in $selected) {
          $urlIndex++
          $ts = Get-Date -Format o
          try {
            Start-Process -FilePath $env:BROWSER_EXE -ArgumentList "--headless=new --disable-gpu --no-sandbox --window-size=1920,1080 --remote-allow-origins=* $site" -ErrorAction Stop | Out-Null
            $successCount++
            "[$ts] URL $urlIndex/$($selected.Count) launched OK: $site" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          } catch {
            $failureCount++
            "[$ts] URL $urlIndex/$($selected.Count) FAILED: $site :: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            Write-Host "URL launch failed: $site :: $($_.Exception.Message)"
          }
          Start-Sleep -Seconds 5
        }

        "- URL launch success count: $successCount" >> $env:GITHUB_STEP_SUMMARY
        "- URL launch failure count: $failureCount" >> $env:GITHUB_STEP_SUMMARY
        "URL launch success count: $successCount" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "URL launch failure count: $failureCount" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

        if ($successCount -eq 0) {
          throw "No URLs were successfully launched."
        }

    - name: Fail if SCP is not connected
      if: steps.check_scp.outputs.is_connected != 'true'
      shell: pwsh
      run: |
        "### SCP Traffic Summary" >> $env:GITHUB_STEP_SUMMARY
        "- SCP connection status: Not Connected" >> $env:GITHUB_STEP_SUMMARY
        Write-Error "SCP connection status is not Connected. Skipping traffic generation."

    - name: Terminate browser processes
      if: always()  # Runs even if previous step failed
      shell: pwsh
      run: |
        Get-Process -Name "chrome", "msedge" -ErrorAction SilentlyContinue | Stop-Process -Force

    - name: Upload diagnostics artifact
      if: always()
      env:
        NODE_EXTRA_CA_CERTS: ${{ github.workspace }}\CA_Skyhigh.pem
      uses: actions/upload-artifact@v4
      with:
        name: scp-diagnostics-main-skyhigh-${{ github.run_id }}
        path: diagnostics/scp-debug.log
        if-no-files-found: warn
