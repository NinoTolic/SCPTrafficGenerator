name: SCP Traffic Generation

on:
  schedule:
    - cron: '0 2 * * *'  # 2:00 AM UTC
  workflow_dispatch:

jobs:
  secure-deployment:
    runs-on: windows-latest
    env:
      PRIVATE_REPO: NinoTolic/SCPTesterFiles
      PAT: ${{ secrets.SCPTesterToken }}

    steps:
    - name: Checkout private resources
      uses: actions/checkout@v4
      with:
        repository: ${{ env.PRIVATE_REPO }}
        token: ${{ secrets.SCPTesterToken }}
        path: SCPTesterFiles
    
    - name: Copy Files Over from Repo
      run: |
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/blob/main/SCP-Windows-493_304.zip -Headers @{Authorization="Token $($env:PAT)"} -OutFile SCP-Windows-493_304.zip
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/blob/main/SCPPolicy.opg -Headers @{Authorization="Token $($env:PAT)"} -OutFile SCPPolicy.opg
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/blob/main/CA_MFE_Tenant.pem -Headers @{Authorization="Token $($env:PAT)"} -OutFile CA_MFE_Tenant.pem

    - name: Unpack the Zip
      run: |
        7z x ./SCP-Windows-493_304.zip

    - name: Install Windows application
      run: |
        Start-Process msiexec -ArgumentList "/i ScpInstaller.x64.msi /quiet" -wait

    - name: Deploy OPG Policy
      run: |
        Copy-Item -Path "./SCPPolicy.opg" -Destination "C:\ProgramData\Skyhigh\SCP\Policy\Temp"

    - name: Install Root CA
      run: |
        Import-Certificate "./CA_MFE_Tenant.pem" -CertStoreLocation Cert:\LocalMachine\Root\ -Confirm:$false

    - name: Access top websites from external list
      shell: pwsh
      run: |
        # Load the list of URLs from the JSON file
        $topSites = Get-Content "./top-sites.json" | ConvertFrom-Json

        # Select 30 random URLs
        $selected = Get-Random -InputObject $topSites -Count 30

        # Open each site in Chrome (or Edge)
        foreach ($site in $selected) {
          Start-Process "chrome.exe" $site
          Start-Sleep -Seconds 10
        }  
