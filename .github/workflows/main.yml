name: SCP Traffic Generation - McAfee - OldGen

on:
  schedule:
    - cron: '0 2 * * *'  # 2:00 AM UTC
  workflow_dispatch:

jobs:
  McAfeeTenant-run:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize diagnostics
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path diagnostics -Force | Out-Null
        "Workflow: $env:GITHUB_WORKFLOW" | Out-File -FilePath diagnostics/scp-debug.log -Encoding utf8
        "Run ID: $env:GITHUB_RUN_ID" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Runner: $env:RUNNER_NAME / $env:RUNNER_OS" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Timestamp: $(Get-Date -Format o)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
    
    - name: Copy Files Over from Private Repo
      shell: pwsh
      env:
        PAT: ${{ secrets.NewSCPToken }}
      run: |
        $ErrorActionPreference = "Stop"
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/SCP-Windows-493_304.zip -Headers @{Authorization="Token $($env:PAT)"} -OutFile SCP-Windows-493_304.zip
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/McAfeeTenant/scp-policy-mcafee-oldgen.opg -Headers @{Authorization="Token $($env:PAT)"} -OutFile scp-policy-mcafee-oldgen.opg
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/McAfeeTenant/CA_MFE_Tenant.pem -Headers @{Authorization="Token $($env:PAT)"} -OutFile CA_MFE_Tenant.pem
        Write-Host "::group::Downloaded Files"
        Get-Item SCP-Windows-493_304.zip, scp-policy-mcafee-oldgen.opg, CA_MFE_Tenant.pem | Select-Object Name,Length,LastWriteTime | Format-Table -AutoSize
        Get-FileHash SCP-Windows-493_304.zip, scp-policy-mcafee-oldgen.opg, CA_MFE_Tenant.pem -Algorithm SHA256 | Format-Table -AutoSize
        Write-Host "::endgroup::"
        Get-FileHash SCP-Windows-493_304.zip, scp-policy-mcafee-oldgen.opg, CA_MFE_Tenant.pem -Algorithm SHA256 | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

    - name: Unpack the SCP Zip
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        7z x ./SCP-Windows-493_304.zip
        Get-ChildItem -Path . -Filter *.msi -Recurse | Select-Object FullName,Length | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

    - name: Pre-install service snapshot
      shell: pwsh
      run: |
        "=== Pre-install services ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue |
            Select-Object Name,DisplayName,Status,StartType | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Service snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }
        "=== Pre-install processes ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Process -Name "*scp*", "*skyhigh*", "chrome" -ErrorAction SilentlyContinue |
            Select-Object Name,Id,StartTime | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Process snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }

    - name: Install Windows SCP application
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Start-Process msiexec -ArgumentList "/i ScpInstaller.x64.msi /quiet" -wait

    - name: Post-install service snapshot
      shell: pwsh
      run: |
        Write-Host "::group::Post-install services"
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue | Format-Table Name,DisplayName,Status,StartType -AutoSize
        } catch {
          Write-Host "Post-install service snapshot failed: $($_.Exception.Message)"
        }
        Write-Host "::endgroup::"
        "=== Post-install services ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue |
            Select-Object Name,DisplayName,Status,StartType | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Post-install service snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }

    - name: Deploy OPG Policy
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Copy-Item -Path "./scp-policy-mcafee-oldgen.opg" -Destination "C:\ProgramData\Skyhigh\SCP\Policy\Temp\SCPPolicy.opg"

    - name: Install Root CA
      timeout-minutes: 5
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $ts = Get-Date -Format o
        $caPath = "./CA_MFE_Tenant.pem"
        if (-not (Test-Path $caPath)) {
          throw "Root CA file not found at $caPath"
        }

        Write-Host "::group::Root CA install diagnostics"
        Write-Host "Start: $ts"
        Get-Item $caPath | Select-Object FullName,Length,LastWriteTime | Format-List
        Get-FileHash $caPath -Algorithm SHA256 | Format-Table -AutoSize

        $sw = [System.Diagnostics.Stopwatch]::StartNew()
        $proc = Start-Process -FilePath "certutil.exe" -ArgumentList @("-f", "-addstore", "Root", $caPath) -PassThru -NoNewWindow
        $completed = $proc.WaitForExit(120000)
        $sw.Stop()

        if (-not $completed) {
          try { $proc.Kill() } catch { }
          "certutil timed out after 120 seconds." | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          throw "certutil -addstore timed out after 120 seconds."
        }

        Write-Host "certutil exit code: $($proc.ExitCode)"
        "certutil exit code: $($proc.ExitCode)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

        if ($proc.ExitCode -ne 0) {
          throw "certutil -addstore failed with exit code $($proc.ExitCode)."
        }

        Write-Host "Import duration seconds: $([Math]::Round($sw.Elapsed.TotalSeconds, 2))"
        "Root CA import at ${ts}; duration_seconds=$([Math]::Round($sw.Elapsed.TotalSeconds, 2))" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "### Root CA Summary" >> $env:GITHUB_STEP_SUMMARY
        "- Import started: $ts" >> $env:GITHUB_STEP_SUMMARY
        "- Import duration seconds: $([Math]::Round($sw.Elapsed.TotalSeconds, 2))" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "::endgroup::"

    - name: Wait after CA installation
      shell: pwsh
      run: Start-Sleep -Seconds 10

    - name: Check SCP Connection Status
      id: check_scp
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $regPath = "HKLM:\SOFTWARE\Skyhigh\SCP\About"
        $valueName = "Connection Status"
        $maxRetries = 3
        $retryDelaySeconds = 15
        $isConnected = $false

        Write-Host "::group::SCP Connection Diagnostics"
        Write-Host "Runner: $env:RUNNER_NAME / $env:RUNNER_OS"
        Write-Host "Registry path: $regPath"
        for ($attempt = 1; $attempt -le ($maxRetries + 1); $attempt++) {
            $ts = Get-Date -Format o
            try {
                $status = Get-ItemPropertyValue -Path $regPath -Name $valueName -ErrorAction Stop
                Write-Host "Attempt $attempt/$($maxRetries + 1) status: '$status' at $ts"
                "SCP status attempt $attempt at ${ts}: $status" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
                if ($status -eq "Connected") {
                    $isConnected = $true
                    break
                }
            } catch {
                Write-Host "Attempt $attempt/$($maxRetries + 1) read failed: $($_.Exception.Message)"
                "SCP status attempt $attempt failed at ${ts}: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            }

            if ($attempt -le $maxRetries) {
                Write-Host "SCP not connected yet. Retrying in $retryDelaySeconds seconds..."
                Start-Sleep -Seconds $retryDelaySeconds
            }
        }

        if ($isConnected) {
            "is_connected=true" >> $env:GITHUB_OUTPUT
        } else {
            "is_connected=false" >> $env:GITHUB_OUTPUT
            Write-Host "::endgroup::"
            throw "SCP connection status did not become Connected after $($maxRetries + 1) attempts."
        }
        Write-Host "::endgroup::"

    - name: Browser diagnostics
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Write-Host "::group::Browser Diagnostics"
        $chromePaths = @(
          "C:\Program Files\Google\Chrome\Application\chrome.exe",
          "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
        )

        $browserExe = $chromePaths | Where-Object { Test-Path $_ } | Select-Object -First 1
        if (-not $browserExe) {
          "Chrome executable not found in standard Program Files paths." | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          Write-Host "::endgroup::"
          throw "Chrome executable not found in standard Program Files paths."
        }

        $browserName = [System.IO.Path]::GetFileName($browserExe)
        Write-Host "Selected browser: $browserName at $browserExe"
        & $browserExe --version
        "Selected browser: $browserExe" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "BROWSER_EXE=$browserExe" >> $env:GITHUB_ENV
        Write-Host "::endgroup::"

    - name: Access top websites from external list
      if: steps.check_scp.outputs.is_connected == 'true'
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        if (-not $env:BROWSER_EXE) {
          throw "BROWSER_EXE environment variable is not set."
        }

        # Load the list of URLs from the JSON file
        $topSites = Get-Content "top-sites.json" | ConvertFrom-Json

        # Select 30 random URLs
        $selected = Get-Random -InputObject $topSites -Count 30
        $successCount = 0
        $failureCount = 0
        $urlIndex = 0

        "Selected URL count: $($selected.Count)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "First 5 URLs: $((($selected | Select-Object -First 5) -join ', '))" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Browser executable: $env:BROWSER_EXE" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "### SCP Traffic Summary" >> $env:GITHUB_STEP_SUMMARY
        "- SCP connection status: Connected" >> $env:GITHUB_STEP_SUMMARY
        "- Selected URL count: $($selected.Count)" >> $env:GITHUB_STEP_SUMMARY
        "- Browser executable: $env:BROWSER_EXE" >> $env:GITHUB_STEP_SUMMARY

        # Open each site in Chrome (or Edge)
        foreach ($site in $selected) {
          $urlIndex++
          $ts = Get-Date -Format o
          try {
            Start-Process -FilePath $env:BROWSER_EXE -ArgumentList "--headless=new --disable-gpu --no-sandbox --window-size=1920,1080 --remote-allow-origins=* $site" -ErrorAction Stop | Out-Null
            $successCount++
            "[$ts] URL $urlIndex/$($selected.Count) launched OK: $site" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          } catch {
            $failureCount++
            "[$ts] URL $urlIndex/$($selected.Count) FAILED: $site :: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            Write-Host "URL launch failed: $site :: $($_.Exception.Message)"
          }
          Start-Sleep -Seconds 5
        }

        "- URL launch success count: $successCount" >> $env:GITHUB_STEP_SUMMARY
        "- URL launch failure count: $failureCount" >> $env:GITHUB_STEP_SUMMARY
        "URL launch success count: $successCount" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "URL launch failure count: $failureCount" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

        if ($successCount -eq 0) {
          throw "No URLs were successfully launched."
        }

    - name: Fail if SCP is not connected
      if: steps.check_scp.outputs.is_connected != 'true'
      shell: pwsh
      run: |
        "### SCP Traffic Summary" >> $env:GITHUB_STEP_SUMMARY
        "- SCP connection status: Not Connected" >> $env:GITHUB_STEP_SUMMARY
        Write-Error "SCP connection status is not Connected. Skipping traffic generation."

    - name: Terminate browser processes
      if: always()  # Runs even if previous step failed
      shell: pwsh
      run: |
        Get-Process -Name "chrome", "msedge" -ErrorAction SilentlyContinue | Stop-Process -Force

    - name: Upload diagnostics artifact
      if: always()
      env:
        NODE_EXTRA_CA_CERTS: ${{ github.workspace }}\CA_MFE_Tenant.pem
      uses: actions/upload-artifact@v4
      with:
        name: scp-diagnostics-main-mcafee-${{ github.run_id }}
        path: diagnostics/scp-debug.log
        if-no-files-found: warn
