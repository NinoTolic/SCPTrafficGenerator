name: SCP Traffic Generation - McAfee - NextGen

on:
  schedule:
    - cron: '0 2 * * *'  # 2:00 AM UTC
  workflow_dispatch:

jobs:
  NextGenSCP-McAfee-run:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize diagnostics
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path diagnostics -Force | Out-Null
        "Workflow: $env:GITHUB_WORKFLOW" | Out-File -FilePath diagnostics/scp-debug.log -Encoding utf8
        "Run ID: $env:GITHUB_RUN_ID" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Runner: $env:RUNNER_NAME / $env:RUNNER_OS" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Timestamp: $(Get-Date -Format o)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
    
    - name: Copy Files Over from Private Repo
      shell: pwsh
      env:
        PAT: ${{ secrets.NewSCPToken }}
      run: |
        $ErrorActionPreference = "Stop"
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/ScpInstaller.x64.msi -Headers @{Authorization="Token $($env:PAT)"} -OutFile ScpInstaller.x64.msi
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/McAfeeTenant/scp-policy-mcafee-nextgen-runner-326.opg -Headers @{Authorization="Token $($env:PAT)"} -OutFile scp-policy-mcafee-nextgen-runner-326.opg
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/NinoTolic/SCPTesterFiles/main/McAfeeTenant/CA_MFE_Tenant.pem -Headers @{Authorization="Token $($env:PAT)"} -OutFile CA_MFE_Tenant.pem
        Write-Host "::group::Downloaded Files"
        Get-Item ScpInstaller.x64.msi, scp-policy-mcafee-nextgen-runner-326.opg, CA_MFE_Tenant.pem | Select-Object Name,Length,LastWriteTime | Format-Table -AutoSize
        Get-FileHash ScpInstaller.x64.msi, scp-policy-mcafee-nextgen-runner-326.opg, CA_MFE_Tenant.pem -Algorithm SHA256 | Format-Table -AutoSize
        Write-Host "::endgroup::"
        Get-FileHash ScpInstaller.x64.msi, scp-policy-mcafee-nextgen-runner-326.opg, CA_MFE_Tenant.pem -Algorithm SHA256 | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

    - name: Install Root CA
      timeout-minutes: 5
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $ts = Get-Date -Format o
        $caPath = "./CA_MFE_Tenant.pem"
        if (-not (Test-Path $caPath)) {
          throw "Root CA file not found at $caPath"
        }

        Write-Host "::group::Root CA install diagnostics"
        Write-Host "Start: $ts"
        Get-Item $caPath | Select-Object FullName,Length,LastWriteTime | Format-List
        Get-FileHash $caPath -Algorithm SHA256 | Format-Table -AutoSize

        $sw = [System.Diagnostics.Stopwatch]::StartNew()
        Write-Host "Starting certutil addstore..."
        $proc = Start-Process -FilePath "certutil.exe" -ArgumentList @("-f", "-addstore", "Root", $caPath) -PassThru -NoNewWindow
        $deadline = (Get-Date).AddSeconds(120)
        while (-not $proc.HasExited -and (Get-Date) -lt $deadline) {
          Start-Sleep -Seconds 5
          Write-Host "certutil still running... elapsed=$([Math]::Round($sw.Elapsed.TotalSeconds, 1))s"
        }
        $completed = $proc.HasExited
        $sw.Stop()

        if (-not $completed) {
          try { $proc.Kill() } catch { }
          "certutil timed out after 120 seconds." | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          throw "certutil -addstore timed out after 120 seconds."
        }

        Write-Host "certutil exit code: $($proc.ExitCode)"
        "certutil exit code: $($proc.ExitCode)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

        if ($proc.ExitCode -ne 0) {
          throw "certutil -addstore failed with exit code $($proc.ExitCode)."
        }

        Write-Host "Import duration seconds: $([Math]::Round($sw.Elapsed.TotalSeconds, 2))"
        "Root CA import at ${ts}; duration_seconds=$([Math]::Round($sw.Elapsed.TotalSeconds, 2))" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "### Root CA Summary" >> $env:GITHUB_STEP_SUMMARY
        "- Import started: $ts" >> $env:GITHUB_STEP_SUMMARY
        "- Import duration seconds: $([Math]::Round($sw.Elapsed.TotalSeconds, 2))" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "::endgroup::"

    - name: Pre-install service snapshot
      shell: pwsh
      run: |
        "=== Pre-install services ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue |
            Select-Object Name,DisplayName,Status,StartType | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Service snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }
        "=== Pre-install processes ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Process -Name "*scp*", "*skyhigh*", "chrome" -ErrorAction SilentlyContinue |
            Select-Object Name,Id,StartTime | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Process snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }

    - name: Install Windows SCP application
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $msiLog = "diagnostics/msi-install.log"
        if (Test-Path $msiLog) { Remove-Item $msiLog -Force }
        $msiArgs = @("/i", "ScpInstaller.x64.msi", "/q", "/norestart", "/l*v", $msiLog)
        Write-Host "Starting msiexec with logging to $msiLog"
        $msi = Start-Process msiexec -ArgumentList $msiArgs -PassThru -Wait
        Write-Host "msiexec exit code: $($msi.ExitCode)"
        "msiexec exit code: $($msi.ExitCode)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        if ($msi.ExitCode -ne 0 -and $msi.ExitCode -ne 3010) {
          if (Test-Path $msiLog) {
            Write-Host "msi log tail (last 60 lines):"
            Get-Content $msiLog -Tail 60 | ForEach-Object { Write-Host $_ }
          }
          throw "msiexec failed with exit code $($msi.ExitCode)."
        }
        if ($msi.ExitCode -eq 3010) {
          Write-Host "msiexec returned 3010 (restart required). Continuing on ephemeral runner."
        }

    - name: Verify SCP installation
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $found = $false
        for ($attempt = 1; $attempt -le 4; $attempt++) {
          $proc = Get-Process -Name "scpservice" -ErrorAction SilentlyContinue
          if ($proc) {
            Write-Host "scpservice.exe found post-install on attempt $attempt/4. PID(s): $($proc.Id -join ', ')"
            "scpservice.exe found post-install on attempt $attempt/4. PID(s): $($proc.Id -join ', ')" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            $found = $true
            break
          }

          Write-Host "scpservice.exe not found on verify attempt $attempt/4."
          "scpservice.exe not found on verify attempt $attempt/4." | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          if ($attempt -lt 4) { Start-Sleep -Seconds 10 }
        }

        if (-not $found) {
          throw "SCP installation verification failed: process 'scpservice.exe' not found."
        }

    - name: Post-install service snapshot
      shell: pwsh
      run: |
        Write-Host "::group::Post-install services"
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue | Format-Table Name,DisplayName,Status,StartType -AutoSize
        } catch {
          Write-Host "Post-install service snapshot failed: $($_.Exception.Message)"
        }
        Write-Host "::endgroup::"
        "=== Post-install services ===" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        try {
          Get-Service -Name "*scp*", "*skyhigh*" -ErrorAction SilentlyContinue |
            Select-Object Name,DisplayName,Status,StartType | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
          "Post-install service snapshot failed: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }

    - name: Deploy OPG Policy
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        New-Item -ItemType Directory -Path "C:\ProgramData\Skyhigh\SCP\Policy\Temp" -Force | Out-Null
        Copy-Item -Path "./scp-policy-mcafee-nextgen-runner-326.opg" -Destination "C:\ProgramData\Skyhigh\SCP\Policy\Temp\SCPPolicy.opg"

    - name: Check SCP Connection Status
      id: check_scp
      timeout-minutes: 3
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $regPath = "HKLM:\SOFTWARE\Skyhigh\SCP\About"
        $regCliPath = "HKLM\SOFTWARE\Skyhigh\SCP\About"
        $valueName = "Status"
        $serviceMaxRetries = 3
        $serviceRetryDelaySeconds = 15
        $registryMaxRetries = 3
        $registryRetryDelaySeconds = 15
        $registryReadTimeoutSeconds = 10
        $isConnected = $false
        $isServiceRunning = $false

        function Invoke-RegQueryWithTimeout {
            param(
                [string]$KeyPath,
                [string]$Name,
                [int]$TimeoutSeconds
            )

            $job = Start-Job -ScriptBlock {
                param($innerKeyPath, $innerName)
                reg.exe query $innerKeyPath /v $innerName 2>&1 | Out-String
            } -ArgumentList $KeyPath, $Name

            if (Wait-Job -Job $job -Timeout $TimeoutSeconds) {
                $output = Receive-Job -Job $job
                Remove-Job -Job $job -Force | Out-Null
                return [pscustomobject]@{
                    TimedOut = $false
                    Output   = $output
                }
            }

            Stop-Job -Job $job -ErrorAction SilentlyContinue | Out-Null
            Remove-Job -Job $job -Force -ErrorAction SilentlyContinue | Out-Null
            return [pscustomobject]@{
                TimedOut = $true
                Output   = ""
            }
        }

        Write-Host "::group::SCP Connection Diagnostics"
        Write-Host "Runner: $env:RUNNER_NAME / $env:RUNNER_OS"
        Write-Host "Registry path: $regPath"
        Write-Host "Starting scpservice.exe checks"
        "Starting scpservice.exe checks" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

        for ($serviceAttempt = 1; $serviceAttempt -le ($serviceMaxRetries + 1); $serviceAttempt++) {
            $serviceTs = Get-Date -Format o
            Write-Host "Service check attempt $serviceAttempt/$($serviceMaxRetries + 1) started at $serviceTs"
            "Service check attempt $serviceAttempt/$($serviceMaxRetries + 1) started at ${serviceTs}" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            $svcProc = Get-Process -Name "scpservice" -ErrorAction SilentlyContinue
            if ($svcProc) {
                Write-Host "scpservice.exe is running on attempt $serviceAttempt/$($serviceMaxRetries + 1). PID(s): $($svcProc.Id -join ', ')"
                "scpservice.exe running on attempt $serviceAttempt/$($serviceMaxRetries + 1). PID(s): $($svcProc.Id -join ', ')" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
                $isServiceRunning = $true
                break
            }

            Write-Host "scpservice.exe is NOT running on attempt $serviceAttempt/$($serviceMaxRetries + 1)."
            "scpservice.exe NOT running on attempt $serviceAttempt/$($serviceMaxRetries + 1)." | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

            if ($serviceAttempt -le $serviceMaxRetries) {
                Write-Host "Waiting $serviceRetryDelaySeconds seconds before next service check..."
                Start-Sleep -Seconds $serviceRetryDelaySeconds
            }
        }

        if (-not $isServiceRunning) {
            Write-Host "::endgroup::"
            throw "scpservice.exe is not running after $($serviceMaxRetries + 1) attempts."
        }

        try {
            Write-Host "Registry dump started via reg.exe query"
            "Registry dump started via reg.exe query" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            $dumpResult = Start-Job -ScriptBlock {
                param($innerKeyPath)
                reg.exe query $innerKeyPath 2>&1 | Out-String
            } -ArgumentList $regCliPath
            if (Wait-Job -Job $dumpResult -Timeout $registryReadTimeoutSeconds) {
                $aboutText = Receive-Job -Job $dumpResult
                Remove-Job -Job $dumpResult -Force | Out-Null
            } else {
                Stop-Job -Job $dumpResult -ErrorAction SilentlyContinue | Out-Null
                Remove-Job -Job $dumpResult -Force -ErrorAction SilentlyContinue | Out-Null
                throw "Registry dump timed out after $registryReadTimeoutSeconds seconds."
            }
            Write-Host "SCP About registry dump:"
            Write-Host $aboutText
            "SCP About registry dump:" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            $aboutText | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        } catch {
            Write-Host "Failed to dump registry key ${regPath}: $($_.Exception.Message)"
            "Failed to dump registry key ${regPath}: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        }

        for ($attempt = 1; $attempt -le ($registryMaxRetries + 1); $attempt++) {
            $ts = Get-Date -Format o
            Write-Host "Registry check attempt $attempt/$($registryMaxRetries + 1) started at $ts"
            "Registry check attempt $attempt/$($registryMaxRetries + 1) started at ${ts}" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            try {
                $query = Invoke-RegQueryWithTimeout -KeyPath $regCliPath -Name $valueName -TimeoutSeconds $registryReadTimeoutSeconds
                if ($query.TimedOut) {
                    throw "Registry query timed out after $registryReadTimeoutSeconds seconds."
                }

                $raw = [string]$query.Output
                $statusMatch = [regex]::Match($raw, "^\s*$valueName\s+REG_\w+\s+(.+)$", [System.Text.RegularExpressions.RegexOptions]::Multiline)
                if (-not $statusMatch.Success) {
                    throw "Could not parse '$valueName' from reg.exe output. Raw output: $raw"
                }
                $status = $statusMatch.Groups[1].Value.Trim()
                Write-Host "Registry attempt $attempt/$($registryMaxRetries + 1) status: '$status' at $ts"
                "SCP status attempt $attempt at ${ts}: $status" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
                if ($status -eq "Secure") {
                    $isConnected = $true
                    break
                }
            } catch {
                Write-Host "Registry attempt $attempt/$($registryMaxRetries + 1) read failed: $($_.Exception.Message)"
                "SCP status attempt $attempt failed at ${ts}: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            }

            if ($attempt -le $registryMaxRetries) {
                Write-Host "SCP not secure yet. Retrying registry check in $registryRetryDelaySeconds seconds..."
                Start-Sleep -Seconds $registryRetryDelaySeconds
            }
        }

        if ($isConnected) {
            "is_connected=true" >> $env:GITHUB_OUTPUT
        } else {
            "is_connected=false" >> $env:GITHUB_OUTPUT
            Write-Host "::endgroup::"
            throw "SCP status did not become Secure after $($registryMaxRetries + 1) attempts."
        }
        Write-Host "::endgroup::"

    - name: Browser diagnostics
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Write-Host "::group::Browser Diagnostics"
        $chromePaths = @(
          "C:\Program Files\Google\Chrome\Application\chrome.exe",
          "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
        )

        $browserExe = $chromePaths | Where-Object { Test-Path $_ } | Select-Object -First 1
        if (-not $browserExe) {
          "Chrome executable not found in standard Program Files paths." | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          Write-Host "::endgroup::"
          throw "Chrome executable not found in standard Program Files paths."
        }

        $browserName = [System.IO.Path]::GetFileName($browserExe)
        Write-Host "Selected browser: $browserName at $browserExe"
        & $browserExe --version
        "Selected browser: $browserExe" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "BROWSER_EXE=$browserExe" >> $env:GITHUB_ENV
        Write-Host "::endgroup::"

    - name: Access top websites from external list
      if: steps.check_scp.outputs.is_connected == 'true'
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        if (-not $env:BROWSER_EXE) {
          throw "BROWSER_EXE environment variable is not set."
        }

        # Load the list of URLs from the JSON file
        $topSites = Get-Content "top-sites.json" | ConvertFrom-Json

        # Select 30 random URLs
        $selected = Get-Random -InputObject $topSites -Count 30
        $successCount = 0
        $failureCount = 0
        $urlIndex = 0

        "Selected URL count: $($selected.Count)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "First 5 URLs: $((($selected | Select-Object -First 5) -join ', '))" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "Browser executable: $env:BROWSER_EXE" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "### SCP Traffic Summary" >> $env:GITHUB_STEP_SUMMARY
        "- SCP status: Secure" >> $env:GITHUB_STEP_SUMMARY
        "- Selected URL count: $($selected.Count)" >> $env:GITHUB_STEP_SUMMARY
        "- Browser executable: $env:BROWSER_EXE" >> $env:GITHUB_STEP_SUMMARY

        # Open each site in Chrome (or Edge)
        foreach ($site in $selected) {
          $urlIndex++
          $ts = Get-Date -Format o
          try {
            Start-Process -FilePath $env:BROWSER_EXE -ArgumentList "--headless=new --disable-gpu --no-sandbox --window-size=1920,1080 --remote-allow-origins=* $site" -ErrorAction Stop | Out-Null
            $successCount++
            "[$ts] URL $urlIndex/$($selected.Count) launched OK: $site" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
          } catch {
            $failureCount++
            "[$ts] URL $urlIndex/$($selected.Count) FAILED: $site :: $($_.Exception.Message)" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
            Write-Host "URL launch failed: $site :: $($_.Exception.Message)"
          }
          Start-Sleep -Seconds 5
        }

        "- URL launch success count: $successCount" >> $env:GITHUB_STEP_SUMMARY
        "- URL launch failure count: $failureCount" >> $env:GITHUB_STEP_SUMMARY
        "URL launch success count: $successCount" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8
        "URL launch failure count: $failureCount" | Out-File -FilePath diagnostics/scp-debug.log -Append -Encoding utf8

        if ($successCount -eq 0) {
          throw "No URLs were successfully launched."
        }

    - name: Fail if SCP is not connected
      if: steps.check_scp.outputs.is_connected != 'true'
      shell: pwsh
      run: |
        "### SCP Traffic Summary" >> $env:GITHUB_STEP_SUMMARY
        "- SCP status: Not Secure" >> $env:GITHUB_STEP_SUMMARY
        Write-Error "SCP status is not Secure. Skipping traffic generation."

    - name: Terminate browser processes
      if: always()  # Runs even if previous step failed
      shell: pwsh
      run: |
        Get-Process -Name "chrome", "msedge" -ErrorAction SilentlyContinue | Stop-Process -Force

    - name: Upload diagnostics artifact
      if: always()
      env:
        NODE_EXTRA_CA_CERTS: ${{ github.workspace }}\CA_MFE_Tenant.pem
      uses: actions/upload-artifact@v4
      with:
        name: scp-diagnostics-nextgen-mcafee-${{ github.run_id }}
        path: diagnostics/scp-debug.log
        if-no-files-found: warn
